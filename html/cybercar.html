<!DOCTYPE html>

<title>CyberCar Viewer</title>
<head>
  <meta charset="utf-8">
  <!-- 引入 ECharts 文件 -->
  <script src="echarts.common.min.js"></script>
</head>
<body>
  <!-- HTML正文开始 -->
  <h3>CyberCar Viewer</h3>

  <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
  <div id="main_chart" style="width: 600px;height:400px;"></div>

  <script language="javascript" type="text/javascript">
    // ECHART
    // 基于准备好的dom，初始化echarts实例
    var myChart = echarts.init(document.getElementById('main_chart'));
    // 指定图表的配置项和数据
    var option = {
      title: {
        text: 'CyberCar运行情况'
      },
      tooltip: {
        trigger: 'axis',
        formatter: function (params){
            mt = params[0];
            sv = params[1];
            //console.log(params['data'][0]);
            time = new Date(mt['data'][0] * 1000);
            function getTime(date, value){
                p = String(value).split('.');
                return "Time:" + date.getMinutes() + ':' + date.getSeconds() + '.' + p[1].substr(0,3) + "\r\nMotor: " + mt['data'][1] + "\r\nServo:" + sv['data'][1]
            }
            return getTime(time, mt['data'][0]);
        },
        axisPointer:{
            animation: false
        }
      },
      legend: {
        data:[
        {name:'电机'},
        {name:'舵机'}
        ]
      },
      xAxis: {
        type: 'value',
        name: '时间'
      },
      yAxis: {
        min: -1,
        max: 1,
        interval: 0.25
      },
      series: [
      {
        name: '电机',
        type: 'line',
        showSymbol: false,
        hoverAnimation: false
      },
      {
        name: '舵机',
        type: 'line',
        showSymbol: false,
        hoverAnimation: false
      }
      ]
    };

    // 使用刚指定的配置项和数据显示图表。
    myChart.setOption(option);
    
    serial_len = 200
    motor_data = []
    servo_data = []
    // 解析客户端发来的信息
    function parseInfo(info){
      obj = JSON.parse(info)
      motor_data.push([obj['tmp'], obj['motor']])
      servo_data.push([obj['tmp'], obj['servo']])
      if (motor_data.length > serial_len){motor_data.shift()}
      if (servo_data.length > serial_len){servo_data.shift()}
      updateChart()
    }
    //更新图表
    function updateChart(){
      myChart.setOption({
        xAxis:{
            min: motor_data[0][0],
            max: motor_data[motor_data.length -1][0] + 2
        },
        series: [{
          data: motor_data
        },
        {
          data: servo_data
        }]
      });
    }

    function init(){
      document.myform.url.value = "ws://" + document.domain + ":8000/"
      // document.myform.inputtext.value = "Hello World!"
      document.myform.disconnectButton.disabled = true;
      doConnect()
    }

    function doConnect(){
      websocket = new WebSocket(document.myform.url.value);
      websocket.onopen = function(evt) { onOpen(evt) };
      websocket.onclose = function(evt) { onClose(evt) };
      websocket.onmessage = function(evt) { onMessage(evt) };
      websocket.onerror = function(evt) { onError(evt) };
    }

    function onOpen(evt){
      writeToScreen("connected\n");
      document.myform.connectButton.disabled = true;
      document.myform.disconnectButton.disabled = false;
    }

    function onClose(evt){
      writeToScreen("disconnected\n");
      document.myform.connectButton.disabled = false;
      document.myform.disconnectButton.disabled = true;
    }

    function onMessage(evt){
      writeToScreen("recv: " + evt.data + '\n');
      parseInfo(evt.data)
    }

    function onError(evt){
      writeToScreen('error: ' + evt.data + '\n');
      websocket.close();
      document.myform.connectButton.disabled = false;
      document.myform.disconnectButton.disabled = true;
    }

    function doSend(message){
      writeToScreen("sent: " + message + '\n'); 
      websocket.send(message);
    }

    function writeToScreen(message){
      document.myform.outputtext.value += message
      document.myform.outputtext.scrollTop = document.myform.outputtext.scrollHeight;
    }

    window.addEventListener("load", init, false);

    function sendText(){
      doSend( document.myform.inputtext.value );
    }

    function clearText(){
      document.myform.outputtext.value = "";
    }

    function doDisconnect(){
      websocket.close();
    }

  </script>

  <div id="output">
    <h4>连接区域</h4>
    <form name="myform">
      <p>
        <div>地址</div>
        <textarea name="url" rows= "3" cols="50"></textarea>
      </p>
      <p>
        <div>日志</div>
        <textarea name="outputtext" rows="20" cols="50"></textarea>
      </p>  
      <!--  
        <p>
          <textarea name="inputtext" cols="50"></textarea>
        </p>
      -->
      
      <p>
        <!--
          <input type="button" name=sendButton value="Send" onClick="sendText();">
        -->
        <input type="button" name=clearButton value="清空" onClick="clearText();">
        <input type="button" name=disconnectButton value="断开" onClick="doDisconnect();">
        <input type="button" name=connectButton value="连接" onClick="doConnect();">
      </p>
    </form>
  </div>

</body>
</html> 

